<?php/***Plugin Name:  WooCommerce MurBeton*Description:  WooCommerce plugin for MurBeton web page purpose*Version:      0.1*Author:       Adam Buczek*Author URI:   https://adamiscoding.pl/*License:      GPL2*License URI:  https://www.gnu.org/licenses/gpl-2.0.html*Text Domain:  woocommerce-murbeton*Domain Path:  /languages*/if (!defined('ABSPATH')) {    exit; // Exit if accessed directly}add_action('wp_footer', 'bbloomer_cart_refresh_update_qty');function bbloomer_cart_refresh_update_qty() {    ?>     <script type="text/javascript">        function setCookie(cname, cvalue, exdays) {            var d = new Date();            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));            var expires = "expires=" + d.toUTCString();            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";        }        function getCookie(name) {            var dc = document.cookie;            var prefix = name + "=";            var begin = dc.indexOf("; " + prefix);            if (begin == -1) {                begin = dc.indexOf(prefix);                if (begin != 0)                    return null;            } else            {                begin += 2;                var end = document.cookie.indexOf(";", begin);                if (end == -1) {                    end = dc.length;                }            }            return decodeURI(dc.substring(begin + prefix.length, end));        }</script>    <?php}/** * Check if WooCommerce is active */if (in_array('woocommerce/woocommerce.php', apply_filters('active_plugins', get_option('active_plugins')))) {    function your_shipping_method_init() {        if (!class_exists('Wc_Murbeton_Transport')) {            class Wc_Murbeton_Transport extends WC_Shipping_Method {                public $isPolbruk = 0;                public $isWieliczka = 0;                public $isLibet = 0;                public $isSwornowski = 0;                public $isGatigo = 0;                public $isPrinted = 0;                public $productToAdd = [];                /**                 * Constructor for your shipping class                 *                 * @access public                 * @return void                 */                public function __construct() {                    $this->id = 'transport-hds';                    $this->title = __('Transport Ciężarowy');                    $this->method_description = __('Transport Auto Ciężarowe'); //                     $this->enabled = "yes"; // This can be added as an setting but for this example its forced enabled                    $this->init();                                    }                /**                 * Initialize integration settings form fields.                 */                public function init_form_fields() {                    $this->form_fields = array(                        'rozlad+2' => array(                            'title' => __('Rozładunek w dwa miejsca', 'transport-hds'),                            'type' => 'price',                            'default' => ''                        ),                        'rozlad+3' => array(                            'title' => __('Rozładunek w trzy miejsca', 'transport-hds'),                            'type' => 'price',                            'default' => ''                        ),                        'odbior_pal' => array(                            'title' => __('Odbiór palet', 'transport-hds'),                            'type' => 'price',                            'default' => ''                        ),                        'przeladunek' => array(                            'title' => __('Przeładunek', 'transport-hds'),                            'type' => 'price',                            'default' => ''                        ),                        'checkbox-1-pal' => array(                            'title' => __('Auto 1 paleta', 'wtransport-hds'),                            'type' => 'checkbox',                            'description' => __('Zaznacz jeżeli chcesz użyć do transportu', 'transport-hds'),                            'desc_tip' => true,                            'default' => ''                        ), 'price-10km-1-pal' => array(                            'title' => __('Cena do 10 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-15km-1-pal' => array(                            'title' => __('Cena do 15 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-20km-1-pal' => array(                            'title' => __('Cena do 20 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-25km-1-pal' => array(                            'title' => __('Cena do 25 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-30km-1-pal' => array(                            'title' => __('Cena do 30 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-35km-1-pal' => array(                            'title' => __('Cena do 35 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-40km-1-pal' => array(                            'title' => __('Cena do 40 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'checkbox-6-pal' => array(                            'title' => __('Auto 6 paleta', 'wtransport-hds'),                            'type' => 'checkbox',                            'description' => __('Zaznacz je�eli chcesz u�y� do transportu', 'transport-hds'),                            'desc_tip' => true,                            'default' => ''                        ), 'price-10km-6-pal' => array(                            'title' => __('Cena do 10 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-15km-6-pal' => array(                            'title' => __('Cena do 15 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-20km-6-pal' => array(                            'title' => __('Cena do 20 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-25km-6-pal' => array(                            'title' => __('Cena do 25 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-30km-6-pal' => array(                            'title' => __('Cena do 30 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-35km-6-pal' => array(                            'title' => __('Cena do 35 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-40km-6-pal' => array(                            'title' => __('Cena do 40 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-45km-6-pal' => array(                            'title' => __('Cena do 45 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-50km-6-pal' => array(                            'title' => __('Cena do 50 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-55km-6-pal' => array(                            'title' => __('Cena do 55 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-60km-6-pal' => array(                            'title' => __('Cena do 60 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-65km-6-pal' => array(                            'title' => __('Cena do 65 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-70km-6-pal' => array(                            'title' => __('Cena do 70 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-75km-6-pal' => array(                            'title' => __('Cena do 75 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-80km-6-pal' => array(                            'title' => __('Cena do 80 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-85km-6-pal' => array(                            'title' => __('Cena do 85 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-90km-6-pal' => array(                            'title' => __('Cena do 90 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-95km-6-pal' => array(                            'title' => __('Cena do 95 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-100km-6-pal' => array(                            'title' => __('Cena do 100 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'checkbox-8-pal' => array(                            'title' => __('Auto 8 paleta', 'wtransport-hds'),                            'type' => 'checkbox',                            'description' => __('Zaznacz je�eli chcesz u�y� do transportu', 'transport-hds'),                            'desc_tip' => true,                            'default' => ''                        ), 'price-10km-8-pal' => array(                            'title' => __('Cena do 10 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-15km-8-pal' => array(                            'title' => __('Cena do 15 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-20km-8-pal' => array(                            'title' => __('Cena do 20 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-25km-8-pal' => array(                            'title' => __('Cena do 25 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-30km-8-pal' => array(                            'title' => __('Cena do 30 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-35km-8-pal' => array(                            'title' => __('Cena do 35 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-40km-8-pal' => array(                            'title' => __('Cena do 40 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-45km-8-pal' => array(                            'title' => __('Cena do 45 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-50km-8-pal' => array(                            'title' => __('Cena do 50 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-55km-8-pal' => array(                            'title' => __('Cena do 55 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-60km-8-pal' => array(                            'title' => __('Cena do 60 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-65km-8-pal' => array(                            'title' => __('Cena do 65 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-70km-8-pal' => array(                            'title' => __('Cena do 70 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-75km-8-pal' => array(                            'title' => __('Cena do 75 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-80km-8-pal' => array(                            'title' => __('Cena do 80 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-85km-8-pal' => array(                            'title' => __('Cena do 85 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-90km-8-pal' => array(                            'title' => __('Cena do 90 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-95km-8-pal' => array(                            'title' => __('Cena do 95 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-100km-8-pal' => array(                            'title' => __('Cena do 100 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'checkbox-14-pal' => array(                            'title' => __('Auto 14 paleta', 'wtransport-hds'),                            'type' => 'checkbox',                            'description' => __('Zaznacz je�eli chcesz u�y� do transportu', 'transport-hds'),                            'desc_tip' => true,                            'default' => ''                        ), 'price-10km-14-pal' => array(                            'title' => __('Cena do 10 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-15km-14-pal' => array(                            'title' => __('Cena do 15 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-20km-14-pal' => array(                            'title' => __('Cena do 20 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-25km-14-pal' => array(                            'title' => __('Cena do 25 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-30km-14-pal' => array(                            'title' => __('Cena do 30 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-35km-14-pal' => array(                            'title' => __('Cena do 35 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-40km-14-pal' => array(                            'title' => __('Cena do 40 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-45km-14-pal' => array(                            'title' => __('Cena do 45 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-50km-14-pal' => array(                            'title' => __('Cena do 50 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-55km-14-pal' => array(                            'title' => __('Cena do 55 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-60km-14-pal' => array(                            'title' => __('Cena do 60 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-65km-14-pal' => array(                            'title' => __('Cena do 65 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-70km-14-pal' => array(                            'title' => __('Cena do 70 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-75km-14-pal' => array(                            'title' => __('Cena do 75 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-80km-14-pal' => array(                            'title' => __('Cena do 80 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-85km-14-pal' => array(                            'title' => __('Cena do 85 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-90km-14-pal' => array(                            'title' => __('Cena do 90 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-95km-14-pal' => array(                            'title' => __('Cena do 95 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-100km-14-pal' => array(                            'title' => __('Cena do 100 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'checkbox-14-pal' => array(                            'title' => __('Auto 14 palet bez hds', 'wtransport-hds'),                            'type' => 'checkbox',                            'description' => __('Zaznacz jeżeli chcesz użyć do transportu', 'transport-hds'),                            'desc_tip' => true,                            'default' => ''                        ), 'price-10km-16-pal' => array(                            'title' => __('Cena do 10 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-15km-16-pal' => array(                            'title' => __('Cena do 15 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-20km-16-pal' => array(                            'title' => __('Cena do 20 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-25km-16-pal' => array(                            'title' => __('Cena do 25 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-30km-16-pal' => array(                            'title' => __('Cena do 30 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-35km-16-pal' => array(                            'title' => __('Cena do 35 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-40km-16-pal' => array(                            'title' => __('Cena do 40 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-45km-16-pal' => array(                            'title' => __('Cena do 45 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-50km-16-pal' => array(                            'title' => __('Cena do 50 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-55km-16-pal' => array(                            'title' => __('Cena do 55 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-60km-16-pal' => array(                            'title' => __('Cena do 60 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-65km-16-pal' => array(                            'title' => __('Cena do 65 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-70km-16-pal' => array(                            'title' => __('Cena do 70 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-75km-16-pal' => array(                            'title' => __('Cena do 75 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-80km-16-pal' => array(                            'title' => __('Cena do 80 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-85km-16-pal' => array(                            'title' => __('Cena do 85 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-90km-16-pal' => array(                            'title' => __('Cena do 90 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-95km-16-pal' => array(                            'title' => __('Cena do 95 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ), 'price-100km-16-pal' => array(                            'title' => __('Cena do 100 km', 'wtransport-hds'),                            'type' => 'price',                            'default' => '',                        ),                    );                }                /**                 * Init your settings                 *                 * @access public                 * @return void                 */                function init() {// Load the settings API                    $this->init_form_fields(); // This is part of the settings API. Override the method to add your own settings                    $this->init_settings(); // This is part of the settings API. Loads settings you previously init.// Save settings in admin if you have any defined                    add_action('woocommerce_update_options_shipping_' . $this->id, array($this, 'process_admin_options'));                }                public function curl_get_response($url) {                    $curl = curl_init();                    curl_setopt_array($curl, array(                        CURLOPT_URL => $url,                        CURLOPT_RETURNTRANSFER => true,                        CURLOPT_TIMEOUT => 30,                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,                        CURLOPT_CUSTOMREQUEST => "GET",                        CURLOPT_HTTPHEADER => array(                            "cache-control: no-cache"                        ),                    ));                    $response = curl_exec($curl);                    $err = curl_error($curl);                    curl_close($curl);                    $response = json_decode($response, true);                    return $response;                }                public function pickup_address($factory) {                    $factory = strtolower($factory);                    if ($factory == "polbruk") {                        $this->isPolbruk = 1;                    } elseif ($factory == "joniec" || $factory = "kost-bet" || $factory = "kostbet") {                        $this->isWieliczka = 1;                    } elseif ($factory == "libet") {                        $this->isWieliczka = 1;                    } elseif ($factory == "gatigo") {                        $this->isWieliczka = 1;                    } elseif ($factory == "swornowski") {                        $this->isWieliczka = 1;                    }                }                /**                 * calculate_shipping function.                 *                 * @access public                 * @param mixed $package                 * @return void                 */                public function calculate_shipping($package = Array()) {                    global $woocommerce;                    $package_first_array = $package["contents"];                    $palets = 0;                    $rest_sum_weight = 0;                    $city_dest_postcode = isset($_POST['calc_shipping_postcode']) ? wc_clean(wp_unslash($_POST['calc_shipping_postcode'])) : $woocommerce->customer->get_shipping_postcode(); // WPCS: input var ok, CSRF ok, sanitization ok.                    $city_dest_name_org = isset($_POST['calc_shipping_city']) ? wc_clean(wp_unslash($_POST['calc_shipping_city'])) : $woocommerce->customer->get_shipping_city(); // WPCS: input var ok, CSRF ok, sanitization ok.                    $city_dest_address_1 = $woocommerce->customer->get_shipping_address_1();                    $city_dest_address_2 = $woocommerce->customer->get_shipping_address_2();                    if (!empty($city_dest_name_org)) {                        $woocommerce->customer->set_shipping_city($city_dest_name_org);                    }                    if (!empty($city_dest_postcode)) {                        $woocommerce->customer->set_shipping_postcode($city_dest_postcode);                    }                    foreach ($package_first_array as $key => $product_data) {                        $product = $product_data["data"];                        $product_name = $product->get_name();                        if (strpos(strtolower($product_name), 'paleta') !== false) {                            continue;                        } else {                            $quantity = $product_data["quantity"];                            $quantity = (float) str_replace(',', '.', $quantity);                            if (key_exists("variation_id", $product_data)) {                                $product = wc_get_product($product_data['product_id']);                            }                            $packaging = $product->get_attribute('pakowanie');                            $packaging = (float) str_replace(',', '.', $packaging);                            $deposit = $product->get_attribute('kaucja-paleta');                            $deposit = (float) str_replace(',', '.', $deposit);                            $factory = $product->get_attribute('producent');                            $weight = $product->get_attribute('waga');                            $weight = (float) str_replace(',', '.', $weight);                            $product_palets = floor($quantity / $packaging);                            $this->pickup_address($factory);                            $rest = $quantity - ($product_palets * $packaging);                            $rest_weight = $rest * $weight;                            $rest_sum_weight = $rest_sum_weight + $rest_weight;                            if ($deposit > 0 || $deposit == "brak") {                                $palets = $palets + $product_palets;                            }                        }                    }                    $rest_palets = ceil($rest_sum_weight / 1500);                    $palets = (int) ($rest_palets + $palets);                    $polskie = array(" ", " - ", "-", "ó", "ę", "ś", "ć", "ż", "ź", "ą", "ł");                    $miedzyn = array("-", "-", "-", "o", "e", "s", "c", "z", "z", "a", "l");                    $city_dest_name = str_replace($polskie, $miedzyn, $city_dest_name_org);                    $city_dest_street = str_replace($polskie, $miedzyn, $city_dest_address_1);                    $city_dest_url = 'https://geocoder.api.here.com/6.2/geocode.json?app_id=M0PxytSZGoWKBljk4JYb&app_code=QH26LmstHlS-dR_gaIeuDQ&searchtext='                            . urldecode($city_dest_name) . '+' . urldecode($city_dest_postcode) . '+' . urldecode($city_dest_street) . '+' . urldecode($city_dest_address_2);                    $city_desc_geodata = $this->curl_get_response($city_dest_url);				if($city_desc_geodata == null){					add_action('woocommerce_before_shipping_calculator', 'print_shipping_message_no_geodata');				}				if($city_dest_name == null){					add_action('woocommerce_before_shipping_calculator', 'print_shipping_message_no_geodata');				}					                    if (!empty($city_desc_geodata) && !empty($city_dest_name)) {                        $city_desce_lat = $city_desc_geodata['Response']['View'][0]['Result'][0]['Location']['NavigationPosition'][0]['Latitude'];                        $city_desc_long = $city_desc_geodata['Response']['View'][0]['Result'][0]['Location']['NavigationPosition'][0]['Longitude'];                        $city_wieliczka_lat = 49.99042;                        $city_wieliczka_long = 20.08208;                        $city_niepolomice_lat = 50.0430599;                        $city_niepolomice_long = 20.1899;                        if ($this->isWieliczka == 1 && $this->isPolbruk == 0 || ($this->isSwornowski == 1 || $this->isGatigo == 1)) {                            $distance_here_url = 'https://route.api.here.com/routing/7.2/calculateroute.json?app_id=M0PxytSZGoWKBljk4JYb&app'                                    . '_code=QH26LmstHlS-dR_gaIeuDQ&waypoint0=geo!' . $city_wieliczka_lat . ',' . $city_wieliczka_long .                                    '&waypoint1=geo!' . $city_desce_lat . ',' . $city_desc_long . '&mode=fastest;truck;traffic:disabled&limitedWeight=30.5&height=4.25'                                    . '&shippedHazardousGoods=harmfulToWater';                        } elseif (                                ($this->isWieliczka == 1 && $this->isPolbruk == 1)                        ) {                            if ($city_wieliczka_long <= $city_desc_long) {                                $distance_here_url = 'https://route.api.here.com/routing/7.2/calculateroute.json?app_id=M0PxytSZGoWKBljk4JYb&app'                                        . '_code=QH26LmstHlS-dR_gaIeuDQ&waypoint0=geo!' . $city_niepolomice_lat . ',' . $city_niepolomice_long .                                        '&waypoint1=geo!' . $city_wieliczka_lat . ',' . $city_wieliczka_long .                                        '&waypoint2=geo!' . $city_desce_lat . ',' . $city_desc_long . '&mode=fastest;truck;traffic:disabled&limitedWeight=30.5&height=4.25'                                        . '&shippedHazardousGoods=harmfulToWater';                            } else {                                $distance_here_url = 'https://route.api.here.com/routing/7.2/calculateroute.json?app_id=M0PxytSZGoWKBljk4JYb&app'                                        . '_code=QH26LmstHlS-dR_gaIeuDQ' .                                        '&waypoint0=geo!' . $city_wieliczka_lat . ',' . $city_wieliczka_long .                                        '&waypoint1=geo!' . $city_niepolomice_lat . ',' . $city_niepolomice_long .                                        '&waypoint2=geo!' . $city_desce_lat . ',' . $city_desc_long . '&mode=fastest;truck;traffic:disabled&limitedWeight=30.5&height=4.25'                                        . '&shippedHazardousGoods=harmfulToWater';                            }                        } elseif (($this->isWieliczka == 0 && $this->isPolbruk == 1)) {                            $distance_here_url = 'https://route.api.here.com/routing/7.2/calculateroute.json?app_id=M0PxytSZGoWKBljk4JYb&app'                                    . '_code=QH26LmstHlS-dR_gaIeuDQ&waypoint0=geo!' . $city_niepolomice_lat . ',' . $city_niepolomice_long .                                    '&waypoint1=geo!' . $city_desce_lat . ',' . $city_desc_long . '&mode=fastest;truck;traffic:disabled&limitedWeight=30.5&height=4.25'                                    . '&shippedHazardousGoods=harmfulToWater';                        }                        $truck_route = $this->curl_get_response($distance_here_url);                        $truck_route_distance = ($truck_route['response']['route'][0]['summary']['distance']) / 1000;                        $packages = $palets;                        $transport_type = [];												if($truck_route_distance > 100 || empty($truck_route_distance)){								add_action('woocommerce_before_shipping_calculator', 'print_shipping_message');								return;							}                        for ($i = 1; $i < 5; $i++) {                            $var = 'car' . $i;                            $$var = true;                        }                        $host = $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'];                        if (!isset($_POST['auto1']) && !isset($_POST['auto2']) && !isset($_POST['auto3']) && !isset($_POST['auto4'])) {                            for ($i = 1; $i < 5; $i++) {                                if (isset($_COOKIE['auto' . $i])) {                                    if ($_COOKIE['auto' . $i] == 1) {                                        $var = 'car' . $i;                                        $$var = true;                                    } else {                                        $var = 'car' . $i;                                        $$var = false;                                    }                                }                            }                        } else {                            for ($i = 1; $i < 5; $i++) {                                if (!isset($_POST['auto' . $i])) {                                    $var = 'car' . $i;                                    $$var = false;                                }                            }                        }							                        for ($i = $packages; $i > 0; $i--) {                            							if (($packages >= 9) && ($car4 !== false) && ($truck_route_distance < 100)) {                                array_push($transport_type, 14);                                $packages = $packages - 14;                            } elseif ($packages >= 7 && ($car3 !== false) && $truck_route_distance < 100) {                                array_push($transport_type, 8);                                $packages = $packages - 8;                            } elseif (($packages >= 3) && ($car2 !== false) && $truck_route_distance < 100) {                                array_push($transport_type, 6);                                $packages = $packages - 6;                            } elseif (($packages >= 1) && ($truck_route_distance > 40) && ($car2 !== false)) {                                array_push($transport_type, 6);                                $packages = $packages - 6;                            } elseif (($packages >= 1) && ($truck_route_distance < 41) && ($car1 !== false)) {                                array_push($transport_type, 1);                                $packages = $packages - 1;                            } elseif (($packages >= 1) && ($truck_route_distance < 100) && ($car2 !== false)) {                                array_push($transport_type, 6);                                $packages = $packages - 6;                            } elseif (($packages >= 1) && ($truck_route_distance < 100) && ($car3 !== false)) {                                array_push($transport_type, 8);                                $packages = $packages - 8;                            } elseif (($packages >= 1) && ($truck_route_distance < 100) && ($car4 !== false)) {                                array_push($transport_type, 14);                                $packages = $packages - 14;                            }                        }                        if ($packages > 0) {                           add_action('woocommerce_before_shipping_calculator', 'print_shipping_message');                        }							                        $roud_up_by_10_distance = ((ceil($truck_route_distance / 5)) * 5);                        if ($roud_up_by_10_distance < 10) {                            $roud_up_by_10_distance = 10;                        }                        $cost = 0;                        if (!empty($transport_type)) {                            foreach ($transport_type as $value) {                                $cost = $cost + $this->settings['price-' . $roud_up_by_10_distance . 'km-' . $value . '-pal'];                            }                        }                        $rate = array(                            'id' => $this->id,                            'label' => $this->title,                            'cost' => $cost,                            'calc_tax' => 'per_item'                        );						                        // Register the rate                        $this->add_rate($rate);                    }                }            }        }    }    add_action('woocommerce_before_cart_table', 'print_shipping_order_message');    add_filter('woocommerce_before_shipping_calculator', 'add_car_form');    function add_car_form() {        return wc_get_cart_url();    }		function print_shipping_message_no_geodata() {        echo '<p style="background:#ff7600;padding:10px;border-radius:10px;color:white;">Nie udało nam się znaleźć takiej lokalizacji, spróbuj wprowadzić adres ponownie lub w innej postaci</p>';    }	    function print_shipping_message() {        echo '<p class="no_way_transport" style="background:red;padding:10px;border-radius:10px;color:white;">Transport HDS nie jest możliwy. Realizujemy transporty do 100 km</p>'; 		}    function print_shipping_order_message() {        echo ('<p style="background:#ff7600;padding:10px;border-radius:10px;color:white;">Potwierdzając dyspozycje zamówienia zostanie ona przesłana do sprawdzenia poprawności oraz dostępności stanów magazynowych. </p>');    }    add_action('woocommerce_before_cart', 'when_adding_to_cart');    add_filter('woocommerce_before_mini_cart_contents', 'when_adding_to_cart');    function when_adding_to_cart() {        global $woocommerce;        $cart_contents = $woocommerce->cart->cart_contents;        $product_palets_sum = [];        $rest_sum_weight = 0;        $existing_palets = [];        foreach ($cart_contents as $key => $product_data) {            $product = $product_data["data"];            $product_name = $product->get_name();            if (strpos(strtolower($product_name), 'paleta') !== false) {                $existing_palets[$product->get_id()] = $product_data["quantity"];                $woocommerce->cart->remove_cart_item($key);            } else {                $quantity = $product_data["quantity"];                $quantity = (float) str_replace(',', '.', $quantity);                if (key_exists("variation_id", $product_data)) {                    $product = wc_get_product($product_data['product_id']);                }                $packaging = $product->get_attribute('pakowanie');                $packaging = (float) str_replace(',', '.', $packaging);                $deposit = $product->get_attribute('kaucja-paleta');                if ($deposit !== "brak") {                    $deposit = (float) str_replace(',', '.', $deposit);                }                $factory = $product->get_attribute('producent');                $weight = $product->get_attribute('waga');                $weight = (float) str_replace(',', '.', $weight);                $package_name = 'Kaucja paleta ' . $factory;                $product_palets = floor($quantity / $packaging);                $rest = $quantity - ($product_palets * $packaging);                $rest_weight = $rest * $weight;                $rest_sum_weight = $rest_sum_weight + $rest_weight;                if ($deposit > 0 || $deposit == "brak") {                    if (key_exists($package_name, $product_palets_sum)) {                        $product_palets_sum[$package_name] = $product_palets_sum[$package_name] + $product_palets;                    } else {                        $product_palets_sum[$package_name] = $product_palets;                    }                }            }        }        $rest_palets = ceil($rest_sum_weight / 1500);        if ($rest_sum_weight > 0) {            $package_name_single = 'Kaucja paleta';            $search_result_single = __search_by_title_only($package_name_single);            if (empty($search_result_single)) {                $package_result_single = add_packaging_products("36,90", $package_name_single);            } else {                $package_result_single = array_shift($search_result_single);            }            $product_palets_sum[$package_name_single] = $rest_palets;        }        foreach ($product_palets_sum as $package_name => $quantity) {            $search_result = __search_by_title_only($package_name);            if (empty($search_result)) {                $package_result = add_packaging_products($deposit, $package_name);            } else {                $package_result = array_shift($search_result);            }            $package_id = $package_result->ID;            if ($quantity > 0) {                $cart_item_key = WC()->cart->add_to_cart($package_id, $quantity);            }        }    }    function customizing_is_purchasable($purchasable, $product) {        if ($product->exists() && ( 'publish' === $product->get_status() || current_user_can('edit_post', $product->get_id()) ))            $purchasable = true;        return $purchasable;    }    function add_packaging_products($price, $name) {        $user = wp_get_current_user();        $post = array(            'post_author' => $user,            'post_content' => '',            'post_status' => "publish",            'post_title' => $name,            'post_parent' => '',            'post_type' => "product",            '_visibility' => 'visible',        );        $post_id = wp_insert_post($post);        update_post_meta($post_id, '_regular_price', $price);        wp_set_object_terms($post_id, 'Palety', 'product_cat');        wp_set_object_terms($post_id, 'simple', 'product_type');        return $post_id;    }    function __search_by_title_only($search) {        global $wpdb;        $args = array(            'post_type' => 'product',            's' => $search,            'exact' => true,            'sentence' => true,        );        if (empty($search))            return $search; // skip processing - no search term in query        $wp_query = new WP_Query($args);        wp_reset_postdata();        return $wp_query->get_posts();    }    function create_product_attribute($label_name) {        global $wpdb;        $slug = sanitize_title($label_name);        if (strlen($slug) >= 28) {            return new WP_Error('invalid_product_attribute_slug_too_long', sprintf(__('Name "%s" is too long (28 characters max). Shorten it, please.', 'woocommerce'), $slug), array('status' => 400));        } elseif (wc_check_if_attribute_name_is_reserved($slug)) {            return new WP_Error('invalid_product_attribute_slug_reserved_name', sprintf(__('Name "%s" is not allowed because it is a reserved term. Change it, please.', 'woocommerce'), $slug), array('status' => 400));        } elseif (taxonomy_exists(wc_attribute_taxonomy_name($label_name))) {            return new WP_Error('invalid_product_attribute_slug_already_exists', sprintf(__('Name "%s" is already in use. Change it, please.', 'woocommerce'), $label_name), array('status' => 400));        }        $data = array(            'attribute_label' => $label_name,            'attribute_name' => $slug,            'attribute_type' => 'select',            'attribute_orderby' => 'menu_order',            'attribute_public' => 0, // Enable archives ==> true (or 1)        );        $results = $wpdb->insert("{$wpdb->prefix}woocommerce_attribute_taxonomies", $data);        if (is_wp_error($results)) {            return new WP_Error('cannot_create_attribute', $results->get_error_message(), array('status' => 400));        }        $id = $wpdb->insert_id;        do_action('woocommerce_attribute_added', $id, $data);        wp_schedule_single_event(time(), 'woocommerce_flush_rewrite_rules');        delete_transient('wc_attribute_taxonomies');    }    function myplugin_activate() {        $attributes = ['wysokość', 'wymiary', 'pakowanie', 'minimalna ilość', 'waga', 'kolor', 'faktura', 'faza', 'na zam�wienie', 'czas dostawy', 'kaucja paleta', 'waga palety', 'wymiar palety', 'materia�', 'przeznaczenie', 'producent'];        foreach ($attributes as $value) {            create_product_attribute($value);        }    }    register_activation_hook(__FILE__, 'myplugin_activate');    add_action('woocommerce_shipping_init', 'your_shipping_method_init');    function add_your_shipping_method($methods) {        $methods['your_shipping_method'] = 'Wc_Murbeton_Transport';        return $methods;    }    /**     * Save the custom field at shipping calculator.     */    function my_custom_shipping_calculator_field() {        $street = isset($_REQUEST['calc_shipping_address_1']) ? $_REQUEST['calc_shipping_address_1'] : '';        if ($street) {            WC()->customer->set_shipping_address_1($street);        }        $number = isset($_REQUEST['calc_shipping_address_2']) ? $_REQUEST['calc_shipping_address_2'] : '';        if ($number) {            WC()->customer->set_shipping_address_2($number);        }    }        add_filter( 'woocommerce_shipping_calculator_enable_country', '__return_false' );    add_action('woocommerce_calculated_shipping', 'my_custom_shipping_calculator_field');    /**     * Adjust the quantity input values     */    add_filter('woocommerce_quantity_input_args', 'jk_woocommerce_quantity_input_args', 10, 2); // Simple products    function jk_woocommerce_quantity_input_args($args, $product) {        if ($product->get_type() == 'variation') {            $product_parent_title = $product->get_parent_data()['title'];            $parent_product = __search_by_title_only($product_parent_title);            if (!empty($parent_product)) {                $product = wc_get_product($parent_product[0]->ID);                $quantity_str = $product->get_attribute('pa_minimalna-ilosc');            }        } else {            $quantity_str = $product->get_attribute('pa_minimalna-ilosc');        }        if (!empty($quantity_str)) {            $quantity = (float) str_replace(',', '.', $quantity_str);            if (is_singular('product')) {                $args['input_value'] = $quantity; // Starting value (we only want to affect product pages, not cart)            }            $args['input_value'] = (float) round($args['input_value'] / $quantity) * $quantity;            $args['min_value'] = (float) $quantity;    // Minimum value            $args['step'] = (float) $quantity;    // Quantity steps            $args['pattern'] = '[0-9]+([\.,][0-9]+)?';            $args['inputmode'] = 'decimal';            return $args;        } else {            $args['min_value'] = 1;    // Minimum value            $args['step'] = 1;    // Quantity steps            return $args;        }    }    add_filter('woocommerce_quantity_input_args', 'hide_quantity_input_field', 20, 2);    function hide_quantity_input_field($args, $product) {        // Here set your product categories in the array (can be either an ID, a slug, a name or an array)        $categories = array('palety');        // Handling product variation        $the_id = $product->is_type('variation') ? $product->get_parent_id() : $product->get_id();        // Only on cart page for a specific product category        if (is_cart() && has_term($categories, 'product_cat', $the_id)) {            echo('<p style="padding-left: 40px; width: 8em !important;">' . $args['input_value'] . '</span>');            $input_value = $args['input_value'];            $args['min_value'] = $args['max_value'] = $input_value;        }        return $args;    }    add_filter('woocommerce_is_purchasable', 'customizing_is_purchasable', 20, 2);    add_filter('woocommerce_shipping_methods', 'add_your_shipping_method');    //    add_filter('woocommerce_checkout_fields', 'custom_override_checkout_fields');    function wpse_load_plugin_css() {        $plugin_url = plugin_dir_url(__FILE__);        wp_enqueue_style('style1', $plugin_url . 'css/style.css');    }    add_action('wp_enqueue_scripts', 'wpse_load_plugin_css');}add_filter('woocommerce_available_variation', 'variable_min_quantity', 10, 1);function variable_min_quantity($variation) {    $product_parent_title = wc_get_product($variation['variation_id'])->get_parent_data()['title'];    $parent_product = __search_by_title_only($product_parent_title);    if (!empty($parent_product)) {        $product = wc_get_product($parent_product[0]->ID);        $quantity_str = $product->get_attribute('pa_minimalna-ilosc');    }    $variation['min_qty'] = $quantity_str;    return $variation;}add_filter('woocommerce_output_related_products_args', 'products_per_page_3', 10, 1);function products_per_page_3($args) {    $args['posts_per_page'] = 3;    $args['columns'] = 3;    return $args;}add_action('after_setup_theme', 'my_theme_setup');function my_theme_setup() {    load_theme_textdomain('ecommerce-solution-child', get_template_directory() . '/languages');}add_action('woocommerce_product_query', 'bbloomer_hide_products_category_shop');function bbloomer_hide_products_category_shop($q) {    $tax_query = (array) $q->get('tax_query');    $tax_query[] = array(        'taxonomy' => 'product_cat',        'field' => 'slug',        'terms' => array('palety'), // Category slug here        'operator' => 'NOT IN'    );    $q->set('tax_query', $tax_query);}function new_query_args($args) {    $args['category'] = 'kostka-brukowa, tarasy, ogrodzenia';    return $args;}function woa_remove_sidebar_class_body($wp_classes) {    $wp_classes[] = 'page-template-template-fullwidth-php';    return $wp_classes;}function sb_conditionally_load_assets(){ if( is_front_page() ) {          wp_dequeue_style('styl1');  wp_dequeue_style('tmpmela-fonts');     wp_dequeue_style('font-awesome');  wp_dequeue_style('tmpmela-admin');//  wp_deregister_style('js_composer_front');//  wp_dequeue_style('tmpmela-tab');  wp_dequeue_style('google-fonts');//  wp_dequeue_style('owl-carousel');//  wp_dequeue_style('owl-transitions');//  wp_dequeue_style('tmpmela-style');  wp_dequeue_style('plugin-install');//  wp_dequeue_style('thickbox');//  wp_dequeue_style('tmpmela-metabox-style');//  wp_dequeue_style('tmpmela-responsive');//  wp_dequeue_style('owl-transitions');//  wp_dequeue_style('owl-transitions');//  wp_dequeue_style('owl-transitions');//  wp_dequeue_style('owl-transitions');//  wp_dequeue_style('owl-transitions');   wp_dequeue_script('photoswipe-ui-default');   wp_dequeue_style('photoswipe-default-skin'); } if (wp_is_mobile()){     }}   add_action( 'wp_enqueue_scripts', 'sb_conditionally_load_assets' );     add_filter( 'option_active_plugins', 'lg_disable_plugin',1 );    function lg_disable_plugin($plugins){        if (is_front_page()) {            $plugins_not_needed = array ('tawkto-live-chat/tawkto.php');            foreach ( $plugins_not_needed as $plugin ) {                $key = array_search( $plugin, $plugins );                if ( false !== $key ) {                    unset( $plugins[ $key ] );                }            }        }        return $plugins;    }    